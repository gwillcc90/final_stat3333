---
title: "Project"
author: "Will Curkan, Alina Ila, Rachel Uc, Jocelyn Serrot, Henry Zerep"
date: "2022-11-18"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
Abortion is a sensitive topic in the United States with the legendary court ruling of *Roe vs. Wade* being overturned in June 2022. While sensitive, it is still an interesting topic because of the different viewpoints: are we killing a baby, or are we killing a fetus? The biology is irrelevant, though, in statistical analyses. Because of the amount of data, it is a good topic of analyses and we shall compare statistics among the categorized demographics of recorded abortions, to see if there are any disparities*****, and double-check claims.

We are using the "Pregnancies, Births and Abortions in the United States: National and State Trends by Age" dataset called `NationalAndStatePregnancy_PublicUse` from the Guttmacher Institute website which sources its data from numerous different organizations like the World Health Origanization (WHO) and UNICEF.

We will use the columns: state, year, abortionratelt15,	abortionrate1517,	abortionrate1819,	abortionrate2024,	abortionrate2529,	abortionrate3034,	abortionrate3539,	abortionrate40plus, which is the rate of abortion per 1000 women in the age range. For example `abortionratelt15` is the rate of abortions of the given U.S. state and year for girls less than 15 years old, and `abortionrate2024` is the rate of abortions for ladies of ages 20-24, per 1000 people.




Some questions to ask:
 - Can we find an estimation region for the true mean abortions for all age groups of women.
 - What is an estimation region for the true mean of abortions of women and girls in Alabama.


 - Is there a statistically significant difference in mean abortion rates among age groups of women and girls.
 - Is there a statistically significant difference in mean abortion rates among states.
 - Is there a statistically significant difference in mean abortion rates among the years.


```{r load_data, echo = F}
abortions <- read.csv(file.choose())
```

```{r libraries, echo = F, warning = F, message=F, include=F}
library(rlang, quietly = T)
library(dplyr, quietly = T)
```


```{r filter_abortion_rates, echo = F}
abortions <- abortions[,c('state','year',
                          'abortionratelt15',	
                          'abortionrate1517',	
                          'abortionrate1819',
                          'abortionrate2024',
                          'abortionrate2529',
                          'abortionrate3034',
                          'abortionrate3539',
                          'abortionrate40plus')]

# dimension of dataset
#dim(abortions)
```


NEED TO CHECK IF DIFFERENCE WITHOUT FILLING VALUES
```{r fill_na, echo = F}
# Want to fill NA values with 0?
abortions[is.na(abortions)] <- 0
```

First, let's look at the most recent mean abortion rate per thousand by age group for all states. This is for the year 2017.

```{r mean_rate_2017, echo = F}
mean_by_year <- aggregate(cbind(abortionratelt15,
                abortionrate1517, abortionrate1819, abortionrate2024,
                abortionrate2529,abortionrate3034, abortionrate3539, 
                abortionrate40plus)~year, data = abortions, mean)

subset(mean_by_year, year == 2017)
########## Checking means individually to make sure above code functions#######
# y2017 <- subset(abortions, year == 2017)
# y2017
# 
# mean(y2017[,'abortionratelt15'])
# mean(y2017[,'abortionrate1517'])
```

The mean abortion rate of all United States looks good. On average, the abortion rate for girls under 15 is .69, and the rate for women 40 and older is 2.65. Of course, this is given samples from each state in 2017 and is not necessarily representative of all abortions that occurred. We shall investigate further with statistical inference tests.

The Guttmacher institute claims that the declining abortion rates are reversing as of 2017 saying "An increase in abortion numbers is a positive development if it means people are getting the health care they want and need" [2]. But, due to the possible uncertainty in the samples, we want to see if there is statistically significant evidence that the abortion rate was dropping in the first place.

### Question: - Is there a statistically significant difference in mean abortion rates from the years 1988 - 2017.

We will use the ANOVA permutation test to see if there is a difference in means among the years.

$H_0: \mu_{1988} = ... = \mu_{2017}$


$H_A: \mu_{1988} \neq ... \neq \mu_{2017}$


```{r create_mean_rate_column, echo = F}
# Add the rate abortion numbers column
abortions$MeanRate <- rowSums(abortions[3:10])/8
```

```{r,echo = F, fig.width=3.8, fig.height=3.8}
hist(abortions$MeanRate, main = 'Mean Rate of Abortions')
```

```{r ANOVA_test_of_means, echo = F}
# Is there a statistically significant difference in mean abortion rates among the years.
year1 <- as.factor(abortions$year)
observed <- anova(lm(abortions$MeanRate ~ year1))$F[1]

n <- length(abortions$MeanRate)
N <- 10^4 - 1
results <- numeric(N)
for (i in 1:N)
{
 index <- sample(n)
 MeanRate.perm <- abortions$MeanRate[index]
 # Ask about this
 results[i] <- anova(lm(MeanRate.perm ~ year1))$F[1]
}

(sum(results >= observed) + 1) / (N + 1)
```

1e-04

P-value is very small, so we confirm that there is a statistically significant difference in mean abortion rate among the years. We will reject the null hypothesis at a 1% level of significance that the mean abortion rate among the years is the same.

We can inspect which years are different from the others with a TukeyHSD test.

```{r}
#TukeyHSD(aov(abortions$MeanRate ~ year1))
```

### Is the variance equal


##################################


### Question: Is there a difference between the mean abortion rate for 1988 and 2017 in the U.S.

$H_0: \mu_{1988} = \mu_{2017}$
$H_A: \mu_{1988} \neq \mu_{2017}$

We subsetted the state for the specific years and plot a histogram to see....

```{r create_1988_2017_subsets, echo = F}
year1988 <- subset(abortions, year == 1988, select = c(year, 
                                                       MeanRate))

year2017 <- subset(abortions, year == 2017, select = c(year, 
                                                       MeanRate))
```


```{r density_88_17, fig.width=3.8, fig.height=3.8}
plot(density(year1988$MeanRate), col = 'red', 
     main = 'Density of the Mean Abortion Rate: 1988 and 2017')
lines(density(year2017$MeanRate), col = 'blue')
legend('topright', c('red: 1988', 'blue: 2017'))
```

From plotting the density of the histograms, we see that in the given sample the means are close because the variances overlap. Also the data is not normal so we need to use non-normal testing methods.

```{r}
# qqnorm(year1988$MeanRate)
# qqline(year1988$MeanRate)
# qqnorm(year2017$MeanRate)
# qqline(year2017$MeanRate)



#BOOTSTRAP 2-sample test for two population means
N <- 10^4

xbar1988 <- mean(unlist(year1988$MeanRate))
xbar2017 <- mean(unlist(year2017$MeanRate))

n1 <- length(year1988$MeanRate)
n2<- length(year2017$MeanRate)

mean.dif <- xbar1988-xbar2017

boot.dif <- numeric(N)

for (i in 1:N){
x <- sample(year1988$MeanRate, n1, replace = TRUE)
y <- sample(year2017$MeanRate, n2, replace = TRUE)
boot.dif[i] <- mean(x) - mean(y)
}

quantile(boot.dif, c(.05,.95))
hist(boot.dif)
abline(v = mean.dif, col="red")

# (sum(boot.dif >= observed) + 1) / (N + 1)
```

From the result we see there is a significant difference, but we know in practice that the permutation test is shown to be more powerful. We will use a permutation test with the assumption that there is no difference in mean rates by pooling the mean rates together, then drawing samples without replacement from the pooling.

```{r, echo = F, fig.width=3.8, fig.height=3.8}
# permutation
N <- 10^4
n1 <- length(year1988$MeanRate)
n1

n2 <- length(year2017$MeanRate)

years_combined <- c(year2017$MeanRate, year1988$MeanRate)
obs.diff <- xbar1988 - xbar2017

mean.diff <- numeric(N)

for (i in 1:N)
{
  indices <- sample(n1, replace = F)
  mean.diff <- years_combined[indices] - years_combined[-indices]
}

hist(mean.diff)
# abline(v = obs.diff)
quantile(mean.diff, c(.05, .95))
```

Using a permutation test of the mean rates, we see that 0 is contained in the interval that contains the true difference in mean rates. We concluse that there is not enough evidence to suggest the mean rate is different in 2017 from 1988


Quick 2-sample bootstrap-t

```{r}
n1 <- length(year1988$MeanRate)
n2 <- length(year2017$MeanRate)
Tstar <- numeric(N)
SE <- sqrt(var(year2017$MeanRate)/n2 + var(year1988$MeanRate)/n1)

for (i in 1:N)
{
  bootx <- sample(year2017$MeanRate, n2, replace = TRUE)
  booty <- sample(year1988$MeanRate, n1, replace = TRUE)
  Tstar[i] <- (mean(bootx) - mean(booty) - obs.diff) /
               sqrt(var(bootx)/n2 + var(booty)/n1)
}

obs.diff - quantile(Tstar, c(.99, .01)) * SE


t.test(year2017$MeanRate, year1988$MeanRate)
```


############################################################
# New YORK!

```{r}
abortions %>%  
  select(state,MeanRate) %>%
  group_by(state) %>% 
  mutate('state_mean' = mean(MeanRate)) %>% 
  arrange(desc(state_mean))
```

NY has highest rate of abortion with mean = 31.43.
We want to perform the interval test to confirm the true mean interval of NY

```{r}
NY_rate <- filter(abortions, state == "NY") %>% select(MeanRate)
NY_rate <- as.vector(unlist(NY_rate))
NY_rate
summary(NY_rate)
```

```{r, fig.width=3.8, fig.height=3.8}
xbar <- 31.43
N <- 10^4
n <- 17 #number of years

Tstar <- numeric(N)

for (i in 1:N)
{
x <-sample(NY_rate, size = n, replace = T)
Tstar[i] <- (mean(x)-xbar)/(sd(x)/sqrt(n))
}
quantile(Tstar, c(0.05, 0.95)) # the first value is negative and the second positive, so we switch

xbar - quantile(Tstar, c(.95, .05))*sd(NY_rate)/sqrt(n)
hist(Tstar, xlab = "T*", main = "Bootstrap distribution of T*")
qqnorm(Tstar)
qqline(Tstar)
```
From the bootstrap distribution, we can see the 90% CI for the true mean is (28.73, 34.305)


### References
[2] https://www.guttmacher.org/article/2022/06/long-term-decline-us-abortions-reverses-showing-rising-need-abortion-supreme-court 
